<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Slot Machine</title>
		<meta name="author" content="mailto:yury.borunov@gmail.com">
		
		<script language="JavaScript">
			"use strict"
			function checkCanvas() {
				return !!document.createElement("canvas").getContext;
			}
			
			var slotMachine = (function(my) {
				var my = my || {},
				elements = [0,1,2,3,4,5,6,7,8,9,10,11,12], elementsLoaded = [],
				elementsVisual = [],
				lineTimers = [],
				slotWidth = 73, slotHeight = 73,
				canvasContext = null,
				lineCmd = [],
				renderedLines = [],
				nextRenderedLines = [];
								
				var initImages = function(callback) {
					var countLoaded = 0,countLoaded2 = 0;
					for(var i=0,elMax=elements.length-1;i<=elMax;i=i+1) {
						var loadingFunc = (function(type){
							var image = new Image();
							image.src = "img"+((type==1)?"":"_blur")+"/"+ elements[i].toString() + ".png";							
							image.onload = (function(img,imgIndex) {
								var myImage = img;
								return (function(){
									elementsLoaded[imgIndex] = !elementsLoaded[imgIndex] ? [] : elementsLoaded[imgIndex];
									elementsLoaded[imgIndex][type-1] = myImage;
									if(type==1) {
										countLoaded += 1;
									}
									else if(type==2) { 
										countLoaded2 += 1;
									}
								
									if(countLoaded === countLoaded2 && countLoaded2 === elements.length) {
										callback();
									}								
								})();
							})(image,i);
							return true;
						});
						loadingFunc(1);//simple
						loadingFunc(2);//blur
					}
				}
				
				var getRandomElement = function(){
					var rndIndex = Math.floor(Math.random() * (elementsLoaded.length-1));
					return elementsLoaded[rndIndex];
				}
				
				var generateRandomElements = function() {
					for(var i=1;i<=5;i=i+1) {
						var placeHolder = [];
						for(var j=1;j<=4;j=j+1) {
							placeHolder.push(getRandomElement());
						}
						elementsVisual.push(placeHolder);
					}
				}
				
				var preRenderLine = function(line,type) {					
					var lineCanvas = document.createElement("canvas");
						lineCanvas.width = slotWidth;
						lineCanvas.height = slotHeight*4;
						var lineCanvasContext = lineCanvas.getContext("2d");
						for(var j=0;j<=3;j++){
							var image = elementsVisual[line][j][type];
							lineCanvasContext.drawImage(image,0,(j*slotHeight)+j);								
						}
						renderedLines[line] = lineCanvas;					
				}
				
				var drawSlots = function() {
					var type = !arguments[0] ? 0 : 1;
					for(var i=0;i<=4;i++){
						preRenderLine(i,type);
						canvasContext.drawImage(renderedLines[i],(i*slotWidth),0);	
					}
				}
				
				var reDrawLine = function(line,top) {
					var end = (top >= slotHeight) ? 2 : 3,
					yAdd = top-slotHeight;
					canvasContext.drawImage(renderedLines[line],(line*slotWidth)+line,yAdd);
				}
				
				var addTopElement = function(line) {
					elementsVisual[line].splice(elementsVisual[line].length-1,1);
					elementsVisual[line] = [].concat([getRandomElement()],elementsVisual[line]);
					preRenderLine(line,1);
				}
				
				my.startAnimateLine = function(line) {
					(function(myLine){
						var topCount = 0;
						lineTimers[myLine] = setInterval(function(){
							if(lineCmd[myLine] && lineCmd[myLine]==="stop") {
								topCount = 0;
								preRenderLine(myLine,0);
								reDrawLine(myLine,topCount);
								clearInterval(lineTimers[myLine]);
								return true;
							}
							
							topCount += 10;
							if(topCount >= slotHeight){
								addTopElement(myLine);		
								topCount = 0;							
							}							
							reDrawLine(myLine,topCount);
						},20);					
					})(line);
				}
				
				my.stopAnimateLine = function(line) {
					lineCmd[line] = "stop";
					if(lineCmd.length==5){
						document.getElementById("butAgain").style.display = "inline";
					}
				}
				
				my.init = function() {
					canvasContext = document.getElementById("gameCanvas").getContext("2d");
					initImages(function(){						
						generateRandomElements();
						drawSlots(true);
						
						for(var i=0;i<=4;i=i+1) {
							my.startAnimateLine(i);
						}
						
						for(var i=0;i<=4;i=i+1) {
							setTimeout((function(line){
								return (function(){
									my.stopAnimateLine(line);
								});
							})(i),(5000+i*2000));
						}
					});
				}
				
				my.reStart = function() {
					lineCmd = [];
					my.init();
					document.getElementById("butAgain").style.display = "none";
				}
				return my;
			})();
			
		
			window.onload = function() {
				document.getElementById("notification").innerHTML = !checkCanvas() ? "Sorry! Your browser doesn't support canvas element!" : "";
				slotMachine.init();
				document.getElementById("butAgain").onclick = function() {
					slotMachine.reStart();
				}
			}
			
			
		</script>
		<style>
			html,body,#main {width:100%;}
			#gameCanvas {border:5px solid black;}
			input {font-size:1.5em;}
			#butAgain {display:none;}
		</style>
	</head>
	<body>
		<div id="main">
			<h1>Play game, have fun!</h1>
			<div id="notification"></div>
			<canvas width="365" height="219" id="gameCanvas"></canvas>
			<br>
			<input type="button" value="Play again" id="butAgain">
		</div>
	</body>
</html>